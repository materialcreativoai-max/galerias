<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî DEMO inteligente</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:900px;margin:0 auto;padding:16px}
h1{font-size:22px;margin:0 0 12px}
.box{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.input{flex:1 1 200px;padding:10px 12px;border-radius:999px;border:1px solid #e2e8f0}
.btn{border-radius:999px;border:1px solid transparent;padding:8px 12px;font-size:14px;cursor:pointer;background:var(--pri);color:#fff}
.btn.ghost{background:#fff;color:#6b7280;border-color:#e2e8f0}
.btn.secondary{background:#e5edff;color:#1e40af}
.btn.mic{background:#fee2e2;color:#b91c1c}
.tiny{font-size:12px;color:#6b7280;margin-top:4px}
.card{border:1px solid #e2e8f0;border-radius:10px;padding:10px;margin-bottom:8px;background:#fff;display:flex;align-items:center;gap:10px}
.card img{width:100px;height:100px;object-fit:cover;border-radius:10px;border:1px solid #ddd;background:#fafafa}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.meta{font-size:12px;color:#566;margin-top:4px}
.ok{padding:8px 10px;background:#eef9f1;border:1px solid #cfead8;border-radius:10px;margin-bottom:12px;color:#145a32;display:none}
.err{padding:8px 10px;background:#fff3f3;border:1px solid #ffd2d2;border-radius:10px;margin-bottom:12px;color:#7a1a1a;display:none}
.switch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#445}
.switch input{transform:scale(1.2)}
@media(max-width:600px){
  .row{flex-direction:column;align-items:stretch}
  .input{width:100%}
  .card{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî DEMO inteligente</h1>
  <div id="status" class="ok"></div>
  <div id="error" class="err"></div>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" placeholder="Ej: 'almorzar en el centro', 'comprar libros', 'comer helados en microcentro'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
      <button id="refreshBtn" class="btn">Actualizar datos</button>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="switch"><input id="autoChk" type="checkbox"/> Auto (15s)</label>
      <div class="tiny" id="srcHint"></div>
      <div class="tiny" id="tsHint" style="margin-left:auto;text-align:right"></div>
    </div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none"></div>
    <div class="tiny" id="intentHint" style="margin-top:4px;display:none"></div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSg0UeYMVZj0b9H2V63XS37oXlIwJ6SL4n-m6WJEbspzM5OP9QA3QF6qSw4fr81dw/pub?gid=1861393565&single=true&output=csv";
const STATUS=document.getElementById("status");
const ERR=document.getElementById("error");
const SRC=document.getElementById("srcHint");
const TSH=document.getElementById("tsHint");
const GPS_HINT=document.getElementById("gpsHint");
const INTENT_HINT=document.getElementById("intentHint");
SRC.textContent="Fuente CSV: "+CSV_URL;

// sin√≥nimos de barrios (en texto normalizado)
const BARRIO_SYNONYMS = {
  "centro":"microcentro",
  "micro centro":"microcentro",
  "micro-centro":"microcentro",
  "zona centrica":"microcentro",
  "zona centrica de buenos aires":"microcentro",
  "obelisco":"microcentro",
  "9 de julio":"microcentro",
  "palermo soho":"palermo",
  "palermo hollywood":"palermo"
};

let DATA=[],USER_POS=null,LOADED=false,refreshTimer=null;

function showStatus(m){STATUS.style.display=m?"block":"none";STATUS.textContent=m||"";}
function showError(m){ERR.style.display=m?"block":"none";ERR.textContent=m||"";}
function hideIntent(){INTENT_HINT.style.display="none";INTENT_HINT.textContent="";}

function removeDiacritics(s){return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function norm(s){return removeDiacritics(String(s||"").toLowerCase()).replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();}
function parseCSV(t){
  const r=t.trim().split(/\r?\n/).map(
    l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,""))
  );
  const h=r.shift().map(x=>x.trim().toLowerCase().replace(/\s+/g,"_"));
  return r.map(l=>Object.fromEntries(h.map((x,i)=>[x,l[i]||""])));
}
function parseCoord(v){
  if(!v)return NaN;
  let s=String(v).replace(",","."),n=parseFloat(s);
  if(!isFinite(n)){
    const d=s.replace(/[^0-9]/g,"");
    if(d.length>=7)n=parseInt(d,10)/1e6;
  }
  if(Math.abs(n)>180)n/=1e6;
  return n;
}
function hav(a,b){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));
}

async function loadCSV(){
  try{
    showError("");showStatus("Cargando CSV‚Ä¶");
    const r=await fetch(CSV_URL+"&nocache="+Date.now(),{cache:"no-store"});
    const txt=await r.text();
    if(/^\s*<!doctype/i.test(txt))throw new Error("HTML en vez de CSV");
    const raw=parseCSV(txt);
    const barrios=new Set();
    DATA=raw.map(row=>{
      const nombre=row.nombre_local||row.nombre||row.local||"";
      const rubro=row.rubro||"";
      const barrio=row.barrio||"";
      const dir=row.direccion||"";
      const kw=row.keywords||"";
      const lat=parseCoord(row.lat),lng=parseCoord(row.lng);
      const nombreNorm=norm(nombre),
            rubroNorm=norm(rubro),
            barrioNorm=norm(barrio),
            kwNorm=norm(kw),
            textNorm=norm([nombre,rubro,barrio,dir,kw].join(" "));
      if(barrioNorm)barrios.add(barrioNorm);
      return {row,nombre,rubro,barrio,dir,kw,lat,lng,nombreNorm,rubroNorm,barrioNorm,kwNorm,textNorm};
    });
    window._BARRIOS = Array.from(barrios);
    LOADED=true;
    showStatus("CSV cargado OK ¬∑ "+DATA.length+" filas.");
    TSH.textContent="Actualizado: "+new Date().toLocaleTimeString();
  }catch(e){
    LOADED=false;
    showStatus("");
    showError("Error CSV: "+(e.message||e));
  }
}

// verbos de intenci√≥n
const VERBOS=["comer","almorzar","cenar","desayunar","comprar","buscar","necesito","arreglar","quiero","tomar","ir","ir a","conseguir","encontrar"];

function detectBarrio(q){
  if(!window._BARRIOS) return "";
  const qnorm = q; // ya viene normalizado

  // primero sin√≥nimos
  for(const [k,target] of Object.entries(BARRIO_SYNONYMS)){
    if(qnorm.includes(k) && window._BARRIOS.includes(target)){
      return target;
    }
  }
  // luego coincidencia directa con valores del sheet
  for(const b of window._BARRIOS){
    if(qnorm.includes(b)) return b;
  }
  return "";
}

function isBarrioToken(t){
  if(!window._BARRIOS) return false;
  if(window._BARRIOS.includes(t)) return true;
  if(BARRIO_SYNONYMS[t] && window._BARRIOS.includes(BARRIO_SYNONYMS[t])) return true;
  return false;
}

function detectLocal(q){
  let match=null;
  for(const d of DATA){
    if(!d.nombreNorm) continue;
    if(q.includes(d.nombreNorm)){
      if(match && match!==d) return null; // m√°s de uno: no fijamos
      match=d;
    }
  }
  return match;
}

function tokenVariants(t){
  const v=new Set([t]);
  if(t.endsWith("s") && t.length>3) v.add(t.slice(0,-1));
  if(t.endsWith("es") && t.length>4) v.add(t.slice(0,-2));
  return Array.from(v);
}

function scoreRow(d,toks,hasVerb){
  let s=0;
  for(const t of toks){
    const vars=tokenVariants(t);
    for(const v of vars){
      if(d.nombreNorm.includes(v)) s+=4;
      if(d.rubroNorm.includes(v)) s+=hasVerb?7:3;
      if(d.kwNorm.includes(v))    s+=hasVerb?6:2;
      if(d.textNorm.includes(v))  s+=1;
    }
  }
  return s;
}

function buscar(fromText){
  hideIntent();
  if(!LOADED){showStatus("Esper√° que cargue el CSV‚Ä¶");return;}

  const raw = (typeof fromText==="string" ? fromText : document.getElementById('qall').value).trim();
  if(!raw){render([],"Escrib√≠ o dict√° algo.");return;}

  const q = norm(raw);
  const hasVerb = VERBOS.some(v=>q.includes(v));

  // 1) ¬ømenciona directamente un local?
  const local = detectLocal(q);
  if(local){
    const dist = (USER_POS && isFinite(local.lat) && isFinite(local.lng))
      ? hav(USER_POS,{lat:local.lat,lng:local.lng})
      : null;
    INTENT_HINT.style.display="block";
    INTENT_HINT.textContent=`üîé Intenci√≥n: "${raw}" ‚Üí local: ${local.nombre}`;
    render([{row:local.row,dist}],`Mostrando: ${local.nombre}`);
    return;
  }

  // 2) detectar barrio (incluye sin√≥nimos)
  const barrioTerm = detectBarrio(q);

  // tokens
  const allTokens = q.split(/\s+/).filter(t=>t.length>2);

  // tokens de contenido (sin verbos ni barrios)
  const contentTokens = allTokens.filter(t=>!VERBOS.includes(t) && !isBarrioToken(t));

  // si no hay ni contenido ni barrio, no hay con qu√© trabajar
  if(!contentTokens.length && !barrioTerm){
    render([],"Prob√° con alguna palabra clave, ej: 'helados', 'libros', 'art√≠culos para el hogar'.");
    return;
  }

  // tokens para puntuar:
  // - si hay contenido ‚Üí usamos contenido
  // - si no hay contenido pero s√≠ barrio ‚Üí usamos todo menos barrios (incluye verbos, ej. 'almorzar')
  const scoringTokens = contentTokens.length
    ? contentTokens
    : allTokens.filter(t=>!isBarrioToken(t)); // p.ej. 'almorzar' en 'almorzar en el centro'

  const requireStrong = hasVerb && contentTokens.length>0; 
  // si solo hay verbo + barrio (ej. 'almorzar en el centro'), NO exigimos strong match

  const out=[];
  for(const d of DATA){
    // filtro por barrio si se detect√≥
    if(barrioTerm && d.barrioNorm && !d.barrioNorm.includes(barrioTerm)) continue;

    const sc = scoreRow(d, scoringTokens, hasVerb);
    if(sc<=0) continue;

    if(requireStrong){
      // pedimos que al menos un token de contenido matchee rubro o keywords
      let strong=false;
      for(const t of contentTokens){
        for(const v of tokenVariants(t)){
          if(d.rubroNorm.includes(v) || d.kwNorm.includes(v)){
            strong=true;
            break;
          }
        }
        if(strong) break;
      }
      if(!strong) continue;
    }

    const dist = (USER_POS && isFinite(d.lat) && isFinite(d.lng))
      ? hav(USER_POS,{lat:d.lat,lng:d.lng})
      : null;

    out.push({row:d.row,dist,score:sc,nombre:d.nombre});
  }

  out.sort((a,b)=>{
    if(a.dist!=null && b.dist!=null && a.dist!==b.dist) return a.dist-b.dist;
    if(b.score!==a.score) return b.score-a.score;
    const na=a.nombre||"",nb=b.nombre||"";
    return na.localeCompare(nb);
  });

  if(out.length){
    let detalle=[];
    if(hasVerb) detalle.push("intenci√≥n detectada");
    if(barrioTerm) detalle.push("zona: "+barrioTerm);
    if(scoringTokens.length) detalle.push("claves: "+scoringTokens.join(", "));
    INTENT_HINT.style.display="block";
    INTENT_HINT.textContent=`üîé Intenci√≥n: "${raw}"${detalle.length?" ‚Üí "+detalle.join(" ¬∑ "):""}`;
  }

  render(out);
}

function buscarCerca(){
  hideIntent();
  if(!LOADED){showStatus("Esper√° que cargue el CSV‚Ä¶");return;}

  function run(){
    const list=[];
    for(const d of DATA){
      if(!isFinite(d.lat)||!isFinite(d.lng)) continue;
      const dist = hav(USER_POS,{lat:d.lat,lng:d.lng});
      list.push({row:d.row,dist});
    }
    list.sort((a,b)=>a.dist-b.dist);

    let radius=1.5;
    let inside=list.filter(o=>o.dist<=radius);
    if(inside.length<3){
      radius=3.0;
      inside=list.filter(o=>o.dist<=radius);
    }

    GPS_HINT.style.display='block';
    GPS_HINT.textContent=`üìç Mostrando ‚â§ ${radius.toFixed(1)} km ¬∑ ${inside.length} resultados`;
    render(inside);
  }

  if(USER_POS){run();return;}

  if(!navigator.geolocation){
    USER_POS={lat:-34.6037,lng:-58.3816};
    GPS_HINT.style.display='block';
    GPS_HINT.textContent="üìç Sin GPS, usando centro.";
    run();
    return;
  }

  showStatus("Buscando tu ubicaci√≥n‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    p=>{
      USER_POS={lat:p.coords.latitude,lng:p.coords.longitude};
      showStatus("");
      GPS_HINT.style.display='block';
      GPS_HINT.textContent="üìç Ubicaci√≥n detectada.";
      run();
    },
    ()=>{
      USER_POS={lat:-34.6037,lng:-58.3816};
      showStatus("");
      GPS_HINT.style.display='block';
      GPS_HINT.textContent="üìç Sin permiso, usando centro.";
      run();
    },
    {enableHighAccuracy:true,timeout:7000}
  );
}

function render(list,msg){
  const box=document.getElementById('results');
  if(!list||!list.length){
    box.innerHTML=`<div class="tiny">${msg||"Sin resultados."}</div>`;
    return;
  }
  box.innerHTML=list.map(o=>{
    const r=o.row;
    const maps=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.direccion||"")+" "+(r.barrio||""))}`;
    const dist=(typeof o.dist==="number")?`<div class="meta">‚âà ${o.dist.toFixed(2)} km</div>`:"";
    const imgSrc=r.imagen_url?r.imagen_url.trim():"";
    const finalSrc=imgSrc
      ? (imgSrc.startsWith("http")?imgSrc:"./"+imgSrc)
      : "";
    const imgTag = finalSrc
      ? `<img src="${finalSrc}" onerror="this.style.display='none'">`
      : "";
    return `<div class="card">
      ${imgTag}
      <div>
        <div class="title">${r.nombre_local||"(sin nombre)"} ‚Äî <span>${r.rubro||""}</span></div>
        <div>${r.direccion||""} ${r.barrio?`(${r.barrio})`:""}</div>
        ${dist}
        <div class="meta"><a href="${maps}" target="_blank">C√≥mo llegar</a></div>
      </div>
    </div>`;
  }).join("");
}

// eventos UI
document.getElementById('goBtn').onclick=()=>buscar();
document.getElementById('clearBtn').onclick=()=>{
  document.getElementById('qall').value='';
  document.getElementById('results').innerHTML='';
  GPS_HINT.style.display='none';
  hideIntent();
  showStatus("");
  showError("");
};
document.getElementById('locBtn').onclick=buscarCerca;
document.getElementById('refreshBtn').onclick=loadCSV;
document.getElementById('autoChk').onchange=e=>{
  if(e.target.checked){
    loadCSV();
    refreshTimer=setInterval(loadCSV,15000);
  }else{
    clearInterval(refreshTimer);
  }
};
document.getElementById('qall').addEventListener('keydown',e=>{
  if(e.key==="Enter"){e.preventDefault();buscar();}
});

// voz
(function(){
  const b=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){b.disabled=true;b.innerText='üé§‚Äî';return;}
  const rec=new SR();
  rec.lang='es-AR';
  rec.continuous=false;
  rec.interimResults=false;
  let active=false;

  b.onclick=()=>{
    if(active)return;
    try{
      rec.start();
      active=true;
      b.textContent='‚è∫Ô∏è';
      showStatus("Escuchando‚Ä¶");
      hideIntent();
    }catch{}
  };
  rec.onresult=e=>{
    const t=e.results[0][0].transcript||'';
    const limpio=t.trim();
    document.getElementById('qall').value=limpio;
    showStatus("Voz: "+limpio);
    buscar(limpio);
  };
  rec.onerror=()=>{showStatus("Error al escuchar.");};
  rec.onend=()=>{active=false;b.textContent='üé§';};
})();

loadCSV();
</script>
</body>
</html>
